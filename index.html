<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>IoT Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
  body { font-family: Arial; margin: 20px; background-color: #f8f8f8; }
  .container { max-width: 1200px; margin: auto; }
  .chart-box {
    background: #fff; padding: 20px; margin-top: 30px;
    border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.15);
  }
  .stats-box { font-size: 14px; margin-bottom: 8px; color:#444; }
  #warningBox {
    background:#ffe6e6; padding:12px; border-left:5px solid red;
    margin-top:25px; white-space:pre-line;
  }
</style>
</head>

<body>
<div class="container">

<h1>IoT Dashboard</h1>

<label>Select date:</label>
<input type="date" id="datePicker">

<br><br>

<label>Select data source:</label>
<select id="sourcePicker">
  <option value="raspberry">Raspberry Pi</option>
  <option value="esp32">ESP32</option>
</select>

<br><br>

<button onclick="loadAll()">Load Data</button>

<!-- TEMPERATURE -->
<div class="chart-box">
  <h3>Temperature (�C)</h3>
  <div id="tempStats" class="stats-box"></div>
  <canvas id="chartTemp"></canvas>
</div>

<!-- HUMIDITY -->
<div class="chart-box">
  <h3>Humidity (%)</h3>
  <div id="humStats" class="stats-box"></div>
  <canvas id="chartHum"></canvas>
</div>

<!-- NOISE -->
<div class="chart-box">
  <h3>Noise (dB)</h3>
  <div id="noiseStats" class="stats-box"></div>
  <canvas id="chartNoise"></canvas>
</div>

<!-- GAS -->
<div class="chart-box">
  <h3>Gas (%)</h3>
  <div id="gasStats" class="stats-box"></div>
  <canvas id="chartGas"></canvas>
</div>

<h3>Warning Log</h3>
<div id="warningBox">No warnings detected.</div>

</div> <!-- container -->


<script>
/* ====================================================================
   LOCAL WARNING LOG (LUU VINH VI?N TRONG TR�NH DUY?T)
==================================================================== */
function getLog(date, source){
  let key = "log_" + source + "_" + date;
  return JSON.parse(localStorage.getItem(key) || "[]");
}

function saveLog(date, source, arr){
  let key = "log_" + source + "_" + date;
  localStorage.setItem(key, JSON.stringify(arr));
}

function appendWarning(date, source, text){
  let log = getLog(date, source);
  log.push(text);
  saveLog(date, source, log);
}

function showWarningLog(date, source){
  let log = getLog(date, source);
  let box = document.getElementById("warningBox");
  if (log.length === 0){
    box.innerText = "No warnings detected.";
  } else {
    box.innerText = log.join("\n\n");
  }
}
/* ====================================================================
   FETCH JSON (NO CACHE)
==================================================================== */
async function loadJSON(file){
  try{
    const res = await fetch(file + "?v=" + Date.now(), {cache:"no-store"});
    if (!res.ok) return null;
    return await res.json();
  }catch(e){ return null; }
}

/* ====================================================================
   FILTERS
==================================================================== */
function filterDate(arr, date){
  if (!arr) return [];
  if (!date) return arr;

  let s = new Date(date + " 00:00:00").getTime();
  let e = new Date(date + " 23:59:59").getTime();

  return arr.filter(x => x.ts >= s && x.ts <= e);
}

function filter5min(arr){
  if (!arr) return [];
  let out=[], last=0;
  for (let p of arr){
    if (p.ts - last >= 300000){
      out.push(p);
      last = p.ts;
    }
  }
  return out;
}

/* ====================================================================
   CHART + STATS
==================================================================== */
function showStats(id, data){
  let box = document.getElementById(id);
  if (!data || data.length === 0){
    box.innerText = "No data";
    return;
  }
  let vals = data.map(x=>x.value);
  box.innerText = "Max: "+Math.max(...vals)+"  |  Min: "+Math.min(...vals);
}

function drawChart(canvasID, label, data, color){
  let ctx = document.getElementById(canvasID).getContext("2d");

  if (window[canvasID]) window[canvasID].destroy();

  if (!data.length){
    window[canvasID] = new Chart(ctx, {
      type:"line",
      data:{ labels:["No data"], datasets:[{label, data:[0]}] }
    });
    return;
  }
    window[canvasID] = new Chart(ctx, {
    type:"line",
    data:{
      labels: data.map(x=>new Date(x.ts).toLocaleTimeString()),
      datasets:[{
        label,
        data: data.map(x=>x.value),
        borderColor: color,
        backgroundColor: color+"33",
        borderWidth:2,
        tension:0.25
      }]
    }
  });
}

/* ====================================================================
   WARNING ENGINE
==================================================================== */
function checkWarnings(entry, date, source){
  let t = new Date(entry.ts).toLocaleTimeString();
  let warnings=[];

  if (entry.temp >= 32)
    warnings.push(`[${t}] HIGH TEMPERATURE: ${entry.temp}�C`);

  if (entry.hum < 40)
    warnings.push(`[${t}] LOW HUMIDITY: ${entry.hum}%`);

  if (entry.hum > 70)
    warnings.push(`[${t}] HIGH HUMIDITY: ${entry.hum}%`);

  if (entry.noise > 85)
    warnings.push(`[${t}] HIGH NOISE: ${entry.noise} dB`);

  if (entry.gas > 10)
    warnings.push(`[${t}] DANGEROUS GAS: ${entry.gas}%`);

  warnings.forEach(msg => appendWarning(date, source, msg));
}

/* ====================================================================
   MAIN LOAD FUNCTION
==================================================================== */
async function loadAll(){
  let date = document.getElementById("datePicker").value;
  let source = document.getElementById("sourcePicker").value;

  let prefix = (source === "raspberry") ? "data_" : "mqtt_";

  let temp  = filter5min(filterDate(await loadJSON(prefix+"temp.json"), date));
  let hum   = filter5min(filterDate(await loadJSON(prefix+"hum.json"), date));
  let noise = filter5min(filterDate(await loadJSON(prefix+"noise.json"), date));
  let gas   = filter5min(filterDate(await loadJSON(prefix+"gas.json"), date));

  showStats("tempStats", temp);
  showStats("humStats", hum);
  showStats("noiseStats", noise);
  showStats("gasStats", gas);

  drawChart("chartTemp", "Temperature (�C)", temp, "#FF0000");
  drawChart("chartHum", "Humidity (%)", hum, "#0066FF");
  drawChart("chartNoise", "Noise (dB)", noise, "#009900");
  drawChart("chartGas", "Gas (%)", gas, "#FF8800");

  /* b?n ghi cu?i d? ki?m tra c?nh b�o */
  if (temp.length && hum.length && noise.length && gas.length){
    let latest = {
      ts: temp[temp.length-1].ts,
      temp: temp[temp.length-1].value,
      hum: hum[hum.length-1].value,
      noise: noise[noise.length-1].value,
      gas: gas[gas.length-1].value
    };
    checkWarnings(latest, date, source);
  }

  /* Hi?n th? to�n b? log c?a source + ng�y */
  showWarningLog(date, source);
}

loadAll();
</script>

</body>
</html>