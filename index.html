<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>IoT Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<style>
  body { font-family: Arial; margin: 20px; background: #f8f8f8; }
  .container { max-width: 1200px; margin: auto; }
  .chart-box { background:#fff;padding:20px;margin:30px 0;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,0.1); }
  .stats { color:#444;font-size:14px;margin-bottom:8px; }
  #warningBox {
    background:#ffe6e6;
    padding:12px;
    border-left:5px solid red;
    margin-top:25px;
    white-space:pre-line;
  }
</style>
</head>

<body>

<div class="container">
  <h1>IoT Dashboard</h1>

  <label>Select date:</label>
  <input type="date" id="datePicker">

  <br><br>

  <label>Data source:</label>
  <select id="sourcePicker">
    <option value="raspberry">Raspberry Pi</option>
    <option value="esp32">ESP32</option>
  </select>

  <br><br>
  <button onclick="loadAll()">Load</button>

  <div class="chart-box">
    <h3>Temperature (�C)</h3>
    <div id="tempStats" class="stats"></div>
    <canvas id="chartTemp"></canvas>
  </div>

  <div class="chart-box">
    <h3>Humidity (%)</h3>
    <div id="humStats" class="stats"></div>
    <canvas id="chartHum"></canvas>
  </div>

  <div class="chart-box">
    <h3>Noise (dB)</h3>
    <div id="noiseStats" class="stats"></div>
    <canvas id="chartNoise"></canvas>
  </div>

  <div class="chart-box">
    <h3>Gas (%)</h3>
    <div id="gasStats" class="stats"></div>
    <canvas id="chartGas"></canvas>
  </div>

  <div id="warningBox">No warnings detected.</div>
</div>

<script>
/* ======================================================
      1. GLOBAL WARNING LOG (KH�NG BAO GI? M?T)
====================================================== */
let warningLog = {};

/* Luu warning theo ng�y */
function addWarning(date, msg){
    if (!warningLog[date]) warningLog[date] = [];
    warningLog[date].push(msg);

    // Luu v�o localStorage (kh�ng bao gi? m?t)
    localStorage.setItem("warningLog", JSON.stringify(warningLog));
}

/* T?i log t? localStorage khi m? web */
(function(){
    const saved = localStorage.getItem("warningLog");
    if (saved) warningLog = JSON.parse(saved);
})();

/* Hi?n th? c?nh b�o */
function showWarnings(date){
    let box = document.getElementById("warningBox");
    if (!warningLog[date] || warningLog[date].length === 0){
        box.innerText = "No warnings detected.";
        return;
    }
    box.innerText = warningLog[date].join("\n\n");
}

/* ======================================================
      2. LOAD JSON
====================================================== */
async function loadJSON(filename){
  try {
    const res = await fetch(filename+"?v="+Date.now(), {cache:"no-store"});
    if (!res.ok) return null;
    return await res.json();
  } catch(e){
    return null;
  }
}

/* ======================================================
      3. FILTER
====================================================== */
function filterByDate(data, date){
  if (!data) return [];
  if (!date) return data;

  const s = new Date(date+" 00:00:00").getTime();
  const e = new Date(date+" 23:59:59").getTime();

  return data.filter(p => p.ts >= s && p.ts <= e);
}

function filter5min(data){
  if (!data) return [];
  const arr=[]; let last=0;

  for(const p of data){
    if (p.ts - last >= 5 * 60 * 1000){
      arr.push(p);
      last = p.ts;
    }
  }
  return arr;
}
/* ======================================================
      4. STATISTICS
====================================================== */
function showStats(id, data){
  if (!data || data.length === 0){
    document.getElementById(id).innerText = "No data";
    return;
  }
  const vals = data.map(a=>a.value);
  document.getElementById(id).innerText =
    "Max: " + Math.max(...vals) + " | Min: " + Math.min(...vals);
}

/* ======================================================
      5. CHART
====================================================== */
function drawChart(canvasID, title, data, color){
  const ctx = document.getElementById(canvasID).getContext("2d");

  if (window[canvasID]) window[canvasID].destroy();

  if (!data || data.length === 0){
    window[canvasID] = new Chart(ctx,{
        type:"line",
        data:{ labels:["No data"], datasets:[{label:title,data:[0]}] }
    });
    return;
  }

  window[canvasID] = new Chart(ctx,{
    type:"line",
    data:{
      labels: data.map(p=>new Date(p.ts).toLocaleTimeString()),
      datasets:[{
        label:title,
        data:data.map(p=>p.value),
        borderColor:color,
        backgroundColor:color+"33",
        tension:0.25,
        borderWidth:2
      }]
    }
  });
}

/* ======================================================
      6. WARNING ENGINE FOR BOTH RASP + ESP
====================================================== */
function checkWarnings(last, date){
    let t = new Date(last.ts).toLocaleTimeString();
    let warn = [];

    if (last.temp >= 32)
        warn.push(`[${t}] ? Temperature HIGH (>=32�C)`);

    if (last.hum < 40)
        warn.push(`[${t}] ? Humidity LOW (<40%)`);

    if (last.hum > 70)
        warn.push(`[${t}] ? Humidity HIGH (>70%)`);

    if (last.noise > 85)
        warn.push(`[${t}] ? Noise HIGH (>85 dB)`);

    if (last.gas > 10)
        warn.push(`[${t}] ? GAS ALERT (>10%)`);

    warn.forEach(w => addWarning(date, w));
}

/* ======================================================
      7. LOAD EVERYTHING
====================================================== */
async function loadAll(){
  const date = document.getElementById("datePicker").value;
  const src  = document.getElementById("sourcePicker").value;

  let prefix = src === "raspberry" ? "data_" : "mqtt_";

  const temp  = filter5min(filterByDate(await loadJSON(prefix+"temp.json"), date));
  const hum   = filter5min(filterByDate(await loadJSON(prefix+"hum.json"),  date));
  const noise = filter5min(filterByDate(await loadJSON(prefix+"noise.json"),date));
  const gas   = filter5min(filterByDate(await loadJSON(prefix+"gas.json"),  date));

  showStats("tempStats", temp);
  showStats("humStats",  hum);
  showStats("noiseStats",noise);
  showStats("gasStats",  gas);

  drawChart("chartTemp", "Temperature", temp, "#FF0000");
  drawChart("chartHum",  "Humidity",    hum,  "#0066FF");
  drawChart("chartNoise","Noise",       noise,"#009900");
  drawChart("chartGas",  "Gas",         gas,  "#FF8800");

  if (temp.length && hum.length && noise.length && gas.length){
    checkWarnings({
      ts: temp[temp.length-1].ts,
      temp: temp[temp.length-1].value,
      hum: hum[hum.length-1].value,
      noise: noise[noise.length-1].value,
      gas: gas[gas.length-1].value
    }, date);
  }

  showWarnings(date);
}

loadAll();
</script>

</body>
</html>